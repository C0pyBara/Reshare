import re

# –ù–∞–±–æ—Ä—ã –∫–ª—é—á–µ–π —Å –≤–µ—Å–∞–º–∏
KEYWORDS_WEIGHTS = {
    # –¢—è–∂–µ–ª—ã–µ (–°–∫–∞–º, –ö—Ä–∏–ø—Ç–∞, –ö–∞–∑–∏–Ω–æ)
    "heavy": {
        "words": ["p2p", "–∞—Ä–±–∏—Ç—Ä–∞–∂", "–ø—Ä–æ—Ñ–∏—Ç", "–∏–∫—Å—ã", "–∞–∏—Ä–¥—Ä–æ–ø", "–ª–∏—Å—Ç–∏–Ω–≥", "–∫–∞–∑–∏–Ω–æ", "—Å—Ç–∞–≤–∫–∏", "–≤—ã–∏–≥—Ä—ã—à", "—Å–ª–æ—Ç—ã"],
        "weight": 5
    },
    # –†–µ–∫–ª–∞–º–Ω—ã–µ (–ü—Ä–æ–¥–∞–∂–∏, –ö—É—Ä—Å—ã)
    "ad": {
        "words": ["–≤–µ–±–∏–Ω–∞—Ä", "–∏–Ω—Ç–µ–Ω—Å–∏–≤", "–º–∞—Ä–∞—Ñ–æ–Ω", "—á–µ–∫-–ª–∏—Å—Ç", "—Å–∫–∏–¥–∫–∞", "–∞–∫—Ü–∏—è", "–∫—É–ø–∏—Ç—å", "–∑–∞–∫–∞–∑–∞—Ç—å", "–ø—Ä–∞–π—Å"],
        "weight": 3
    },
    # –ü—Ä–∏–∑—ã–≤—ã (CTA - Call to Action)
    "cta": {
        "words": ["–ø–æ–¥–ø–∏—à–∏—Å—å", "–∑–∞–∫—Ä–µ–ø–µ", "–ø–µ—Ä–µ—Ö–æ–¥–∏", "–∑–∞–±–∏—Ä–∞–π", "–∂–º–∏", "—Å—Å—ã–ª–∫–∞", "–≤—Ö–æ–¥", "—á–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ"],
        "weight": 4
    }
}

# –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã (Regex)
AD_PATTERNS = [
    r"–º–µ—Å—Ç(?:–∞)? –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ",
    r"–≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è",
    r"—á–∏—Ç–∞—Ç—å (?:–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ|–¥–∞–ª–µ–µ)",
    r"—É—Å–ø–µ–π (?:–∑–∞–±—Ä–∞—Ç—å|–≤—Å—Ç—É–ø–∏—Ç—å|–∫—É–ø–∏—Ç—å)",
    r"–∑–∞–≥–ª—è–Ω–∏ –≤ –∑–∞–∫—Ä–µ–ø",
    r"–Ω–∞ –ø—Ä–∞–≤–∞—Ö —Ä–µ–∫–ª–∞–º—ã",
    r"–≤—ã–ª–æ–∂–∏–ª –≤ –∑–∞–∫—Ä—ã—Ç—ã–π",
    r"—Ü–µ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∞"
]

def improved_heuristic_score(text: str) -> float:
    if not text: return 0.0
    text_lower = text.lower()
    score = 0.0

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–ª—é—á–µ–π
    for category, data in KEYWORDS_WEIGHTS.items():
        for word in data["words"]:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ (—Å–∫–∏–¥–∫ -> —Å–∫–∏–¥–∫–∞, —Å–∫–∏–¥–∫–∏)
            if word in text_lower:
                score += data["weight"]

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (—Ü–µ–ª—ã—Ö —Ñ—Ä–∞–∑)
    for pattern in AD_PATTERNS:
        if re.search(pattern, text_lower):
            score += 6.0  # –§—Ä–∞–∑—ã ‚Äî –æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä

    # 3. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏—è
    # –ú–Ω–æ–≥–æ –∫–Ω–æ–ø–æ–∫ –∏–ª–∏ —Å—Å—ã–ª–æ–∫
    links_count = len(re.findall(r"https?://|t\.me/", text_lower))
    score += links_count * 4.0

    # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∫–∞–ø—Å (–∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã)
    upper_ratio = sum(1 for c in text if c.isupper()) / len(text) if len(text) > 0 else 0
    if upper_ratio > 0.3 and len(text) > 20:
        score += 3.0

    # –ü–ª–æ—Ç–Ω–æ—Å—Ç—å —ç–º–æ–¥–∑–∏ (—Ä–µ–∫–ª–∞–º–∞ –æ–±—ã—á–Ω–æ –ø–µ—Å—Ç—Ä–∏—Ç –∏–º–∏)
    emoji_count = len(re.findall(r'[^\w\s,.!?]', text_lower))
    if len(text) > 0 and (emoji_count / len(text)) > 0.1:
        score += 2.0

    return score

def is_ad_refined(text: str, threshold: float = 4.0) -> bool:
    """
    –ü–æ—Ä–æ–≥ 8.0 –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å –æ–±—ã—á–Ω–æ–µ '–∫—É–ø–∏–ª —Å–∫–∏–¥–∫—É'.
    """
    return improved_heuristic_score(text) >= threshold

# –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
heuristic_spam_score = improved_heuristic_score

# –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏
if __name__ == "__main__":
    test_msg = "üî• –£–°–ü–ï–ô –ó–ê–ë–†–ê–¢–¨! –ú–µ—Å—Ç –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ. –ú–æ—è —Å–µ–∫—Ä–µ—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è p2p –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ –≤ –∑–∞–∫—Ä–µ–ø–µ: t.me/link"
    print(f"–°–∫–æ—Ä: {improved_heuristic_score(test_msg)}, –†–µ–∫–ª–∞–º–∞: {is_ad_refined(test_msg)}")